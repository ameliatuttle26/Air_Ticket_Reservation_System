{% extends "base.html" %}
{% block content %}

<style>
    .dashboard-header {
        text-align: center;
        margin-bottom: 20px;
    }

    .dashboard-card {
        background: rgba(255, 255, 255, 0.75);
        padding: 20px 25px;
        margin: 20px auto;
        width: 85%;
        border-radius: 18px;
        box-shadow: 0 6px 18px rgba(0,0,0,0.15);
    }

    .dashboard-card h2 {
        text-align: center;
        margin-bottom: 15px;
        font-size: 1.5rem;
    }

    .btn-main {
        display: block;
        width: 100%;
        max-width: 350px;
        margin: 12px auto;
        padding: 12px;
        background-color: #E58A5C;
        color: white;
        text-align: center;
        border-radius: 12px;
        text-decoration: none;
        font-size: 1.1rem;
    }

    .styled-table {
        width: 100%;
        border-collapse: collapse;
        border-radius: 12px;
        overflow: hidden;
        margin-top: 10px;
    }

    .styled-table th, 
    .styled-table td {
        padding: 10px;
        text-align: center;
    }

    .styled-table tr:nth-child(even) {
        background-color: #f4f4f4;
    }

    .stats-chart {
        width: 100%;
        max-height: 350px;
        margin-top: 10px;
    }
</style>


<div class="dashboard-header">
    <h1>Welcome Back, {{ session['user_id'] }} ‚úàÔ∏è</h1>
</div>

<!-- FIXED BUTTON LINKS -->
<div class="dashboard-card">
    <h2>Agent Tools</h2>

    <!-- üî• FIXED: now uses agent_search instead of bad endpoint -->
    <a href="{{ url_for('agent_search') }}" class="btn-main">
        Purchase Flight for Customer
    </a>

    <a href="{{ url_for('agent_view_bookings') }}" class="btn-main">
        View Your Booked Flights
    </a>

</div>


<!-- COMMISSION SUMMARY -->
<div class="dashboard-card">
    <h2>Commission Summary (Last 30 Days)</h2>
    <p><strong>Total:</strong> ${{ "%.2f"|format(commission_summary.total_commission or 0) }}</p>
    <p><strong>Average per Ticket:</strong> ${{ "%.2f"|format(commission_summary.avg_commission or 0) }}</p>
    <p><strong>Tickets Sold:</strong> {{ commission_summary.num_tickets }}</p>
</div>

<!-- TOP CUSTOMERS: TICKETS -->
<div class="dashboard-card">
    <h2>Top 5 Customers ‚Äî Tickets (Last 6 Months)</h2>
    <canvas id="chartTickets" class="stats-chart"></canvas>
</div>

<!-- TOP CUSTOMERS: COMMISSION -->
<div class="dashboard-card">
    <h2>Top 5 Customers ‚Äî Commission (Last Year)</h2>
    <canvas id="chartCommission" class="stats-chart"></canvas>
</div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>

    // --- Convert safe Jinja data into proper JS arrays ---
    const ticketLabels = {{ top_customers_by_tickets | map(attribute='customer_email') | list | tojson }};
    const ticketData   = {{ top_customers_by_tickets | map(attribute='num_tickets') | list | tojson }};

    const commissionLabels = {{ top_customers_by_commission | map(attribute='customer_email') | list | tojson }};
    const commissionData   = {{ top_customers_by_commission | map(attribute='total_commission') | list | tojson }};

    console.log("Tickets Labels:", ticketLabels);
    console.log("Tickets Data:", ticketData);
    console.log("Commission Labels:", commissionLabels);
    console.log("Commission Data:", commissionData);

    // --- Fallback so chart NEVER disappears ---
    const safeTicketLabels     = ticketLabels.length     ? ticketLabels     : ["No Data"];
    const safeTicketData       = ticketData.length       ? ticketData       : [0];
    const safeCommissionLabels = commissionLabels.length ? commissionLabels : ["No Data"];
    const safeCommissionData   = commissionData.length   ? commissionData   : [0];


    // ---- TICKETS CHART ----
    new Chart(document.getElementById("chartTickets"), {
        type: 'bar',
        data: {
            labels: safeTicketLabels,
            datasets: [{
                label: "Tickets Sold",
                data: safeTicketData,
                backgroundColor: "#E58A5C"
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });


    // ---- COMMISSION CHART ----
    new Chart(document.getElementById("chartCommission"), {
        type: 'bar',
        data: {
            labels: safeCommissionLabels,
            datasets: [{
                label: "Commission ($)",
                data: safeCommissionData,
                backgroundColor: "#E58A5C"
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

</script>


{% endblock %}
